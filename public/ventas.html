<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Punto Bazar - Ventas y comisiones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/logo.svg" />
  <style>
    :root {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.98);
      --borde: rgba(148, 163, 184, 0.45);
      --texto: #e5e7eb;
      --muted: #9ca3af;
      --violeta: #8b5cf6;
    }
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: transparent;
      color: var(--texto);
    }
    h1 {
      margin-top: 0;
      font-size: 1.3rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: 1rem;
      border: 1px solid var(--borde);
      padding: 1rem;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.95);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.82rem;
      color: #cbd5e1;
    }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.2rem;
      padding: 0.45rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #020617;
      color: var(--texto);
      font-size: 0.88rem;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-main {
      background: linear-gradient(135deg, #4f46e5, #a855f7);
      color: #fff;
      box-shadow: 0 12px 30px rgba(88, 80, 236, 0.8);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--texto);
    }
    .btn-mini {
      padding: 0.25rem 0.6rem;
      font-size: 0.78rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
    .btn-danger {
      background: rgba(248, 113, 113, 0.2);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
      font-size: 0.8rem;
    }
    th, td {
      padding: 0.4rem 0.3rem;
      border-bottom: 1px solid rgba(30, 64, 175, 0.5);
      text-align: left;
    }
    th {
      background: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .items-wrap {
      max-height: 260px;
      overflow: auto;
      border-radius: 0.7rem;
      border: 1px solid rgba(30, 64, 175, 0.6);
      margin-top: 0.4rem;
    }
    .status {
      margin-top: 0.5rem;
      font-size: 0.82rem;
      min-height: 1.1rem;
    }
    .status-ok {
      color: #4ade80;
    }
    .status-error {
      color: #f97373;
    }
    .totales {
      margin-top: 0.7rem;
      font-size: 0.88rem;
    }
    .totales div {
      margin-bottom: 0.2rem;
    }
    .subtitulo {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 0;
    }
    .mini-resumen {
      margin-top: 0.8rem;
      padding-top: 0.6rem;
      border-top: 1px solid rgba(30, 64, 175, 0.6);
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .mini-resumen div {
      margin-bottom: 0.2rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1>Ventas y comisiones</h1>
  <p style="font-size:.86rem;color:#9ca3af;margin-top:-.4rem;margin-bottom:.8rem;">
    Registrá las ventas, asignalas a un revendedor y armá el detalle con varios productos.
  </p>

  <div class="layout">
    <!-- FORMULARIO PRINCIPAL -->
    <section class="card">
      <h2 class="subtitulo">Datos de la venta</h2>

      <label for="v-fecha">Fecha</label>
      <input id="v-fecha" type="date" />

      <label for="v-revendedor">Revendedor</label>
      <select id="v-revendedor">
        <option value="">Elegí un revendedor...</option>
      </select>

      <label for="v-cliente">Cliente (nombre)</label>
      <input id="v-cliente" placeholder="Ej: Juan Pérez (opcional)" />

      <div class="row-2">
        <div>
          <label for="v-comision">Comisión (%)</label>
          <input id="v-comision" type="number" min="0" max="100" value="20" />
        </div>
        <div>
          <label for="v-total-manual">Total (opcional)</label>
          <input id="v-total-manual" type="number" min="0" step="0.01"
                 placeholder="Si lo dejás vacío, se calcula con los productos." />
        </div>
      </div>

      <label for="v-detalle">Notas / detalle extra (opcional)</label>
      <textarea id="v-detalle" placeholder="Ej: Entrega viernes tarde, combo especial, etc."></textarea>

      <button id="btn-guardar-venta" class="btn btn-main" style="margin-top:.9rem;">
        Guardar venta
      </button>

      <div id="venta-status" class="status"></div>

      <div class="totales">
        <div><strong>Total por productos:</strong> $ <span id="total-productos">0.00</span></div>
        <div><strong>Comisión estimada:</strong> $ <span id="total-comision">0.00</span></div>
      </div>

      <div class="mini-resumen" id="mini-resumen">
        <!-- se llena con /api/ventas -->
      </div>
    </section>

    <!-- PRODUCTOS DE LA VENTA -->
    <section class="card">
      <h2 class="subtitulo">Productos de esta venta</h2>

      <div class="row-2">
        <div>
          <label for="item-producto">Producto</label>
          <select id="item-producto">
            <option value="">Elegí un producto...</option>
          </select>
        </div>
        <div>
          <label for="item-cantidad">Cantidad</label>
          <input id="item-cantidad" type="number" min="1" value="1" />
        </div>
      </div>

      <button id="btn-agregar-item" class="btn btn-ghost" style="margin-top:.7rem;">
        Agregar producto a la venta
      </button>

      <div class="items-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="items-body">
            <tr>
              <td colspan="5" style="text-align:center;color:#9ca3af;">
                Todavía no agregaste productos a esta venta.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p style="font-size:.78rem;color:#9ca3af;margin-top:.5rem;">
        Tip: podés armar la venta solo con productos y el total se calcula solo, o cargar un total manual arriba si querés redondear.
      </p>
    </section>
  </div>

  <script>
    const selRevendedor = document.getElementById('v-revendedor');
    const inpFecha = document.getElementById('v-fecha');
    const inpCliente = document.getElementById('v-cliente');
    const inpComision = document.getElementById('v-comision');
    const inpTotalManual = document.getElementById('v-total-manual');
    const inpDetalle = document.getElementById('v-detalle');
    const ventaStatus = document.getElementById('venta-status');
    const totalProductosEl = document.getElementById('total-productos');
    const totalComisionEl = document.getElementById('total-comision');
    const miniResumenEl = document.getElementById('mini-resumen');

    const selItemProducto = document.getElementById('item-producto');
    const inpItemCantidad = document.getElementById('item-cantidad');
    const btnAgregarItem = document.getElementById('btn-agregar-item');
    const itemsBody = document.getElementById('items-body');
    const btnGuardarVenta = document.getElementById('btn-guardar-venta');

    let listaRevendedores = [];
    let listaProductos = [];
    let ventaItems = [];

    function setStatus(msg, ok) {
      ventaStatus.textContent = msg || '';
      ventaStatus.className = 'status' + (msg ? (ok ? ' status-ok' : ' status-error') : '');
    }

    function formatearPrecio(n) {
      return Number(n || 0).toFixed(2);
    }

    function initFechaHoy() {
      const hoy = new Date();
      const y = hoy.getFullYear();
      const m = String(hoy.getMonth() + 1).padStart(2, '0');
      const d = String(hoy.getDate()).padStart(2, '0');
      inpFecha.value = `${y}-${m}-${d}`;
    }

    function cargarRevendedores() {
      fetch('/api/revendedores')
        .then(r => r.json())
        .then(data => {
          listaRevendedores = Array.isArray(data) ? data : [];
          const activos = listaRevendedores.filter(r => r.activo !== false);
          selRevendedor.innerHTML = '<option value="">Elegí un revendedor...</option>' +
            activos.map(r =>
              `<option value="${r.id}">${r.nombre || ('Rev ' + r.id)}${r.zona ? ' · ' + r.zona : ''}</option>`
            ).join('');
        })
        .catch(() => {
          setStatus('Error cargando revendedores.', false);
        });
    }

    function cargarProductos() {
      fetch('/api/productos/activos')
        .then(r => r.json())
        .then(data => {
          listaProductos = Array.isArray(data) ? data : [];
          selItemProducto.innerHTML = '<option value="">Elegí un producto...</option>' +
            listaProductos.map(p =>
              `<option value="${p.id}">#${p.id} · ${p.nombre || 'Sin nombre'} ($${formatearPrecio(p.precio)})</option>`
            ).join('');
        })
        .catch(() => {
          setStatus('Error cargando productos.', false);
        });
    }

    function cargarMiniResumen() {
      fetch('/api/ventas')
        .then(r => r.json())
        .then(data => {
          const lista = Array.isArray(data) ? data : [];
          if (!lista.length) {
            miniResumenEl.innerHTML = '<div>No hay ventas registradas todavía.</div>';
            return;
          }

          let totalGlobal = 0;
          const porRev = {};
          lista.forEach(v => {
            const t = Number(v.total || 0);
            totalGlobal += t;
            const key = v.revendedor_nombre || ('Rev ' + (v.revendedor_id || '?'));
            porRev[key] = (porRev[key] || 0) + t;
          });

          let mejorNombre = '';
          let mejorTotal = 0;
          Object.keys(porRev).forEach(nombre => {
            if (porRev[nombre] > mejorTotal) {
              mejorTotal = porRev[nombre];
              mejorNombre = nombre;
            }
          });

          miniResumenEl.innerHTML = `
            <div><strong>Ventas registradas:</strong> ${lista.length}</div>
            <div><strong>Total histórico:</strong> $ ${formatearPrecio(totalGlobal)}</div>
            ${mejorNombre
              ? `<div><strong>Top revendedor:</strong> ${mejorNombre} ($${formatearPrecio(mejorTotal)})</div>`
              : ''
            }
          `;
        })
        .catch(() => {
          miniResumenEl.innerHTML = '<div style="color:#f97373;">Error al cargar resumen de ventas.</div>';
        });
    }

    function renderItems() {
      if (!ventaItems.length) {
        itemsBody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;color:#9ca3af;">Todavía no agregaste productos a esta venta.</td></tr>';
        totalProductosEl.textContent = '0.00';
        totalComisionEl.textContent = '0.00';
        return;
      }

      let total = 0;
      const filas = ventaItems.map((it, idx) => {
        const sub = it.cantidad * it.precio;
        total += sub;
        return `
          <tr>
            <td>${it.nombre}</td>
            <td>${it.cantidad}</td>
            <td>$ ${formatearPrecio(it.precio)}</td>
            <td>$ ${formatearPrecio(sub)}</td>
            <td>
              <button class="btn-mini btn-danger" data-idx="${idx}" data-role="quitar">
                Quitar
              </button>
            </td>
          </tr>
        `;
      }).join('');

      itemsBody.innerHTML = filas;
      totalProductosEl.textContent = formatearPrecio(total);

      const porc = Number(inpComision.value || 0);
      const comision = Math.round((total * porc) / 100);
      totalComisionEl.textContent = formatearPrecio(comision);
    }

    btnAgregarItem.addEventListener('click', () => {
      const prodId = Number(selItemProducto.value || 0);
      const cant = Number(inpItemCantidad.value || 0);
      if (!prodId) {
        setStatus('Elegí un producto para agregar.', false);
        return;
      }
      if (!cant || cant <= 0) {
        setStatus('La cantidad debe ser mayor a cero.', false);
        return;
      }
      const prod = listaProductos.find(p => Number(p.id) === prodId);
      if (!prod) {
        setStatus('Producto no encontrado.', false);
        return;
      }
      const existente = ventaItems.find(it => it.producto_id === prodId);
      if (existente) {
        existente.cantidad += cant;
      } else {
        ventaItems.push({
          producto_id: prodId,
          nombre: prod.nombre || ('Producto ' + prodId),
          precio: Number(prod.precio || 0),
          cantidad: cant
        });
      }
      setStatus('', true);
      renderItems();
    });

    itemsBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-role="quitar"]');
      if (!btn) return;
      const idx = Number(btn.getAttribute('data-idx'));
      if (isNaN(idx)) return;
      ventaItems.splice(idx, 1);
      renderItems();
    });

    btnGuardarVenta.addEventListener('click', () => {
      const revId = Number(selRevendedor.value || 0);
      if (!revId) {
        setStatus('Elegí un revendedor para la venta.', false);
        return;
      }
      const rev = listaRevendedores.find(r => Number(r.id) === revId);
      const revNombre = rev ? rev.nombre || '' : '';

      const fecha = inpFecha.value || '';
      const clienteTexto = inpCliente.value.trim();
      const comisionPorc = Number(inpComision.value || 0);
      let totalNum = Number(inpTotalManual.value || 0);

      if (!ventaItems.length && totalNum <= 0) {
        setStatus('Agregá al menos un producto o cargá un total manual.', false);
        return;
      }

      if (totalNum <= 0 && ventaItems.length) {
        totalNum = ventaItems.reduce((acc, it) => acc + it.cantidad * it.precio, 0);
      }

      const detalleExtra = inpDetalle.value.trim();

      const pedidos = [];

      // Si hay items, mandamos UNA venta por producto
      if (ventaItems.length) {
        ventaItems.forEach((it, idx) => {
          const sub = it.cantidad * it.precio;
          const detTexto =
            `Venta multi-producto (item ${idx + 1}/${ventaItems.length}): ${it.nombre} x${it.cantidad}.` +
            (detalleExtra ? '\n\nNotas:\n' + detalleExtra : '');

          pedidos.push({
            revendedor_id: revId,
            revendedor_nombre: revNombre,
            fecha,
            total: sub,
            comision_porcentaje: comisionPorc,
            cliente_id: null,
            cliente_texto: clienteTexto,
            producto_id: it.producto_id,
            cantidad_producto: it.cantidad,
            detalle: detTexto
          });
        });
      } else {
        // Sin items, solo total manual (sin actualizar stock)
        const detTexto = detalleExtra || 'Venta registrada sin detalle de productos.';
        pedidos.push({
          revendedor_id: revId,
          revendedor_nombre: revNombre,
          fecha,
          total: totalNum,
          comision_porcentaje: comisionPorc,
          cliente_id: null,
          cliente_texto: clienteTexto,
          producto_id: null,
          cantidad_producto: 0,
          detalle: detTexto
        });
      }

      setStatus('Guardando venta...', true);

      Promise.all(
        pedidos.map(body =>
          fetch('/api/ventas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          }).then(r => r.json())
        )
      )
        .then(() => {
          setStatus('Venta guardada correctamente.', true);
          ventaItems = [];
          renderItems();
          inpTotalManual.value = '';
          inpDetalle.value = '';
          inpCliente.value = '';
          cargarMiniResumen();
        })
        .catch(() => {
          setStatus('Error al guardar la venta.', false);
        });
    });

    (function init() {
      initFechaHoy();
      cargarRevendedores();
      cargarProductos();
      cargarMiniResumen();
      renderItems();
    })();
  </script>
</body>
</html>
