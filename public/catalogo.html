<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Punto Bazar - Cat√°logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/logo.svg" />
  <style>
    :root {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.98);
      --card-soft: rgba(15, 23, 42, 0.92);
      --borde: rgba(148, 163, 184, 0.4);
      --texto: #e5e7eb;
      --muted: #9ca3af;
      --violeta: #8b5cf6;
      --violeta2: #4f46e5;
      --verde: #4ade80;
      --rojo: #f97373;
      --amarillo: #facc15;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 50%, #000 100%);
      color: var(--texto);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      text-align: center;
      padding: 0.6rem 0.5rem 0.4rem;
      background: linear-gradient(to bottom, rgba(15,23,42,0.98), rgba(15,23,42,0.8), transparent);
      backdrop-filter: blur(12px);
    }
    header img {
      width: 150px;
      filter: drop-shadow(0 14px 32px rgba(15, 23, 42, 0.95));
    }
    .cart-badge {
      position: absolute;
      top: 0.7rem;
      right: 1rem;
      background: linear-gradient(135deg,#4f46e5,#a855f7);
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(88,80,236,0.9);
    }
    .cart-badge span.icon {
      font-size: 1rem;
    }

    .rev-banner {
      max-width: 1200px;
      margin: 0.2rem auto 0.4rem;
      padding: 0.45rem 0.65rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(52,211,153,0.8);
      background: radial-gradient(circle at left, rgba(34,197,94,0.2), rgba(15,23,42,0.95));
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem 0.7rem;
      align-items: center;
      justify-content: space-between;
    }
    .rev-banner strong {
      color: #bbf7d0;
    }

    .cat-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(320px, 1.15fr);
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.5rem 1rem 1rem;
    }
    main h1 {
      font-size: 1.3rem;
      margin: 0 0 .2rem;
    }
    main p {
      font-size: 0.9rem;
      color: var(--muted);
      margin: 0 0 .6rem;
    }

    /* Filtros */
    .filter-panel {
      background: var(--card-soft);
      border-radius: 0.9rem;
      border: 1px solid var(--borde);
      padding: 0.5rem 0.7rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      display: grid;
      grid-template-columns: minmax(0,1.4fr) repeat(3,minmax(0,1fr));
      gap: 0.4rem;
      align-items: flex-end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .filter-label {
      font-size: 0.72rem;
      color: var(--muted);
    }
    .filter-panel input,
    .filter-panel select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      color: var(--texto);
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }
    .filter-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin: 0.5rem 0 0.2rem;
    }
    .chip {
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.72rem;
      border: 1px solid rgba(75, 85, 99, 0.9);
      cursor: pointer;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.8);
    }
    .chip-active {
      border-color: #a855f7;
      background: rgba(76, 29, 149, 0.7);
    }

    /* OFERTAS DEL D√çA */
    .ofertas-card {
      margin: 0.5rem 0 0.7rem;
      padding: 0.7rem 0.7rem 0.5rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(251,191,36,0.8);
      background: radial-gradient(circle at left top, rgba(251,191,36,0.25), rgba(15,23,42,0.98));
      box-shadow: 0 18px 40px rgba(202,138,4,0.5);
    }
    .ofertas-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.45rem;
      gap:0.4rem;
    }
    .ofertas-title {
      font-size:0.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:0.3rem;
    }
    .ofertas-title span.icon {
      font-size:1.1rem;
    }
    .ofertas-sub {
      font-size:0.78rem;
      color:#facc15;
    }
    .ofertas-list {
      display:flex;
      gap:0.5rem;
      overflow-x:auto;
      padding-bottom:0.2rem;
    }
    .oferta-item {
      min-width: 180px;
      max-width: 220px;
      background: rgba(15,23,42,0.96);
      border-radius:0.8rem;
      border:1px solid rgba(148,163,184,0.35);
      padding:0.4rem 0.5rem 0.5rem;
      font-size:0.8rem;
      flex-shrink:0;
    }
    .oferta-img {
      border-radius:0.65rem;
      overflow:hidden;
      background:radial-gradient(circle at top,#1f2937,#020617);
      height:110px;
      margin-bottom:0.3rem;
    }
    .oferta-img img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .oferta-nombre {
      font-weight:600;
      margin-bottom:0.1rem;
    }
    .oferta-precio-row {
      display:flex;
      align-items:baseline;
      gap:0.25rem;
    }
    .oferta-precio-main {
      color:#fde68a;
      font-weight:700;
    }
    .oferta-precio-old {
      text-decoration:line-through;
      color:#9ca3af;
      font-size:0.75rem;
    }
    .oferta-btn {
      margin-top:0.3rem;
      display:inline-flex;
      align-items:center;
      gap:0.2rem;
      padding:0.25rem 0.6rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.75rem;
      background:linear-gradient(135deg,#f97316,#ec4899);
      color:#fff;
    }

    /* Grid de productos */
    .cat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 0.8rem;
    }
    .cat-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transform: translateY(0);
      transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s;
      position: relative;
      cursor:pointer;
    }
    .cat-card:hover {
      transform: translateY(-3px);
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 20px 50px rgba(79, 70, 229, 0.9);
    }
    .badge-ribbon {
      position: absolute;
      top: 0.5rem;
      left: 0;
      padding: 0.15rem 0.55rem;
      border-radius: 0 999px 999px 0;
      font-size: 0.7rem;
      background: linear-gradient(135deg,#f97316,#ea580c);
      color: #fef3c7;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      box-shadow: 0 6px 14px rgba(124,45,18,0.9);
    }
    .badge-ribbon span {
      font-size: 0.75rem;
    }

    .cat-img-wrap {
      position: relative;
      padding-top: 70%;
      background: radial-gradient(circle at top, #1f2937, #020617);
      overflow:hidden;
    }
    .cat-img-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cat-body {
      padding: 0.6rem 0.7rem 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .cat-name {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .cat-cat {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .cat-price-row {
      display: flex;
      align-items: baseline;
      gap: 0.25rem;
    }
    .cat-price-main {
      font-size: 0.95rem;
      font-weight: 700;
      color: #c4b5fd;
    }
    .cat-price-old {
      font-size: 0.78rem;
      text-decoration: line-through;
      color: #9ca3af;
    }
    .cat-stock {
      font-size: 0.75rem;
      color: #6ee7b7;
    }
    .cat-stock.low {
      color: #facc15;
    }
    .cat-stock.none {
      color: #f97373;
    }
    .cat-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: 0.7rem;
      color: var(--muted);
    }
    .tag {
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 0.05rem 0.45rem;
    }
    .cat-actions {
      display: flex;
      gap: 0.3rem;
      align-items: center;
      margin-top: 0.3rem;
    }
    .cat-qty {
      width: 50px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: #020617;
      color: #e5e7eb;
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.7rem;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-main {
      background: linear-gradient(135deg, #4f46e5, #a855f7);
      color: #fff;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(75, 85, 99, 0.9);
      color: #e5e7eb;
    }

    /* Carrito */
    .cart-card {
      background: rgba(15, 23, 42, 0.97);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 1rem;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      position: sticky;
      top: 4.4rem;
    }
    .cart-title {
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.95rem;
    }
    .cart-items {
      max-height: 320px;
      overflow: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(30, 64, 175, 0.5);
      padding: 0.4rem;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
      font-size: 0.8rem;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
      padding: 0.25rem 0.2rem;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
    }
    .cart-empty {
      text-align: center;
      color: #9ca3af;
      padding: 0.5rem 0;
    }
    .cart-total {
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
    }
    .cart-actions {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .cart-note {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .cart-note textarea {
      width: 100%;
      margin-top: 0.2rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: #020617;
      color: var(--texto);
      font-size: 0.78rem;
      padding: 0.35rem 0.5rem;
      resize: vertical;
    }

    @media (max-width: 900px) {
      .cat-layout {
        grid-template-columns: minmax(0, 1fr);
        padding: 0.5rem 0.6rem 1rem;
      }
      .cart-card {
        position: static;
      }
      .filter-panel {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="/logo.svg" alt="Punto Bazar" />
    <div class="cart-badge" onclick="document.getElementById('cart-items').scrollIntoView({behavior:'smooth'})">
      <span class="icon">üõí</span>
      <span id="cart-count">0</span>
    </div>
  </header>

  <div id="rev-banner" class="rev-banner" style="display:none;">
    <div>
      Est√°s comprando a trav√©s de <strong id="rev-nombre">Revendedor</strong>
      <span id="rev-zona" style="color:#9ca3af;"></span>
    </div>
    <div style="font-size:.78rem;color:#bbf7d0;">
      Todo lo que encargues por este cat√°logo se registra como ventas de esta persona üíö
    </div>
  </div>

  <div class="cat-layout">
    <main>
      <h1>Cat√°logo Punto Bazar</h1>
      <p>
        Eleg√≠ tus productos, arm√° el pedido y envi√° por WhatsApp. Pod√©s filtrar por categor√≠a, rango de precio y ver ofertas destacadas.
      </p>

      <!-- FILTROS AVANZADOS -->
      <section class="filter-panel">
        <div class="filter-group">
          <span class="filter-label">Buscar</span>
          <input type="text" id="f-buscar" placeholder="Nombre, categor√≠a o palabra clave..." />
        </div>
        <div class="filter-group">
          <span class="filter-label">Categor√≠a</span>
          <select id="f-categoria">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Rango de precio</span>
          <select id="f-precio">
            <option value="">Todos</option>
            <option value="1-5000">$1 - $5.000</option>
            <option value="5000-15000">$5.000 - $15.000</option>
            <option value="15000-999999">$15.000+</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Orden</span>
          <select id="f-orden">
            <option value="recomendado">Recomendado</option>
            <option value="precio-asc">Precio ‚Üë</option>
            <option value="precio-desc">Precio ‚Üì</option>
            <option value="nombre-asc">Nombre A-Z</option>
            <option value="nombre-desc">Nombre Z-A</option>
          </select>
        </div>
      </section>

      <div class="filter-chip-row" id="chip-row"></div>

      <!-- OFERTAS DEL D√çA -->
      <section id="ofertas-section" class="ofertas-card" style="display:none;">
        <div class="ofertas-header">
          <div class="ofertas-title">
            <span class="icon">üî•</span>
            <span>Ofertas del d√≠a</span>
          </div>
          <div class="ofertas-sub" id="ofertas-sub"></div>
        </div>
        <div class="ofertas-list" id="ofertas-list"></div>
      </section>

      <!-- GRID -->
      <div class="cat-grid" id="grid-productos">
        <div style="grid-column:1/-1; text-align:center; color:#9ca3af;">
          Cargando productos...
        </div>
      </div>
    </main>

    <aside>
      <div class="cart-card">
        <div class="cart-title">
          <span>Tu pedido</span>
          <span style="font-size:.78rem;color:#9ca3af;" id="cart-resumen-mini"></span>
        </div>
        <div class="cart-items" id="cart-items">
          <div class="cart-empty">Todav√≠a no agregaste productos.</div>
        </div>
        <div class="cart-total">
          <span>Total estimado</span>
          <strong id="cart-total">$ 0.00</strong>
        </div>

        <div class="cart-note">
          Nota para el pedido (opcional)
          <textarea id="cart-nota" placeholder="Ej: Entrega por la tarde, color preferido, etc."></textarea>
        </div>

        <div class="cart-actions">
          <button class="btn btn-main" id="btn-wsp-ricardo">Enviar a Ricardo</button>
          <button class="btn btn-ghost" id="btn-wsp-eliseo">Enviar a Eliseo</button>
          <button class="btn btn-ghost" id="btn-vaciar">Vaciar pedido</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ---- CARRITO GLOBAL (localStorage) ----
    function cargarCarritoLS() {
      try {
        return JSON.parse(localStorage.getItem('pb_carrito') || '[]');
      } catch (e) {
        return [];
      }
    }
    function guardarCarritoLS() {
      localStorage.setItem('pb_carrito', JSON.stringify(carrito));
      actualizarBadgeCarrito();
    }
    function cantidadTotalCarrito() {
      return carrito.reduce(function (acc, item) { return acc + item.cantidad; }, 0);
    }
    function actualizarBadgeCarrito() {
      var badge = document.getElementById('cart-count');
      if (badge) badge.textContent = cantidadTotalCarrito();
      var mini = document.getElementById('cart-resumen-mini');
      if (!mini) return;
      var cant = cantidadTotalCarrito();
      if (!cant) {
        mini.textContent = '';
        return;
      }
      mini.textContent = cant + ' √≠tem' + (cant > 1 ? 's' : '');
    }

    function getParam(name) {
      var params = new URLSearchParams(location.search);
      return params.get(name);
    }

    var todosProductos = [];
    var categoriaFiltro = 'Todos';
    var carrito = cargarCarritoLS();
    var revId = getParam('rev');
    var revNombre = '';
    var revZona = '';

    var grid = document.getElementById('grid-productos');
    var cartItemsEl = document.getElementById('cart-items');
    var cartTotalEl = document.getElementById('cart-total');
    var btnVaciar = document.getElementById('btn-vaciar');
    var btnWspRicardo = document.getElementById('btn-wsp-ricardo');
    var btnWspEliseo = document.getElementById('btn-wsp-eliseo');
    var cartNota = document.getElementById('cart-nota');
    var revBanner = document.getElementById('rev-banner');
    var revNombreEl = document.getElementById('rev-nombre');
    var revZonaEl = document.getElementById('rev-zona');

    var fBuscar = document.getElementById('f-buscar');
    var fCategoria = document.getElementById('f-categoria');
    var fPrecio = document.getElementById('f-precio');
    var fOrden = document.getElementById('f-orden');
    var chipRow = document.getElementById('chip-row');

    var ofertasSection = document.getElementById('ofertas-section');
    var ofertasList = document.getElementById('ofertas-list');
    var ofertasSub = document.getElementById('ofertas-sub');

    function calcularPrecioOferta(base, tipo, valor) {
      var precioBase = Number(base || 0);
      var v = Number(valor || 0);
      if (!tipo || !v || precioBase <= 0) return precioBase;
      if (tipo === 'porcentaje') {
        var desc = (precioBase * v) / 100;
        return Math.max(0, precioBase - desc);
      }
      if (tipo === 'precio') {
        return Math.max(0, v);
      }
      return precioBase;
    }

    // ---- CATEGOR√çAS + CHIPS ----
    function renderCategorias() {
      var cats = ['Todos'];
      todosProductos.forEach(function (p) {
        if (p.categoria && cats.indexOf(p.categoria) === -1) {
          cats.push(p.categoria);
        }
      });
      fCategoria.innerHTML = '<option value="">Todas</option>' +
        cats.filter(function (c) { return c !== 'Todos'; }).map(function (cat) {
          return '<option value="' + cat + '">' + cat + '</option>';
        }).join('');

      chipRow.innerHTML = cats.map(function (cat) {
        return '<button class="chip ' +
          (cat === categoriaFiltro ? 'chip-active' : '') +
          '" data-cat="' + cat + '">' + cat + '</button>';
      }).join('');
    }

    chipRow.addEventListener('click', function (e) {
      var btn = e.target.closest('.chip');
      if (!btn) return;
      categoriaFiltro = btn.getAttribute('data-cat');
      renderCategorias();
      renderProductos();
    });

    // ---- FILTROS + ORDEN ----
    function aplicarFiltrosOrden() {
      var lista = todosProductos.slice();
      var q = (fBuscar.value || '').toLowerCase().trim();
      var cat = fCategoria.value || '';
      var precioRango = fPrecio.value || '';
      var ord = fOrden.value || 'recomendado';

      if (q) {
        lista = lista.filter(function (p) {
          var nombre = (p.nombre || '').toLowerCase();
          var categoria = (p.categoria || '').toLowerCase();
          var desc = (p.descripcion || '').toLowerCase();
          return nombre.includes(q) || categoria.includes(q) || desc.includes(q);
        });
      }

      if (categoriaFiltro !== 'Todos') {
        lista = lista.filter(function (p) {
          return p.categoria === categoriaFiltro;
        });
      }

      if (cat) {
        lista = lista.filter(function (p) {
          return p.categoria === cat;
        });
      }

      if (precioRango) {
        var partes = precioRango.split('-');
        var min = Number(partes[0] || 0);
        var max = Number(partes[1] || 999999999);
        lista = lista.filter(function (p) {
          var base = Number(p.precio || 0);
          var final = calcularPrecioOferta(base, p.oferta_tipo || '', p.oferta_valor || 0);
          return final >= min && final <= max;
        });
      }

      lista.sort(function (a, b) {
        var baseA = Number(a.precio || 0);
        var baseB = Number(b.precio || 0);
        var finalA = calcularPrecioOferta(baseA, a.oferta_tipo || '', a.oferta_valor || 0);
        var finalB = calcularPrecioOferta(baseB, b.oferta_tipo || '', b.oferta_valor || 0);
        switch (ord) {
          case 'precio-asc': return finalA - finalB;
          case 'precio-desc': return finalB - finalA;
          case 'nombre-asc': return (a.nombre || '').localeCompare(b.nombre || '');
          case 'nombre-desc': return (b.nombre || '').localeCompare(a.nombre || '');
          case 'recomendado':
          default:
            var scoreA = 0, scoreB = 0;
            if (a.oferta_tipo && a.oferta_valor) scoreA += 2;
            if (b.oferta_tipo && b.oferta_valor) scoreB += 2;
            if (a.stock > 0) scoreA += 1;
            if (b.stock > 0) scoreB += 1;
            return scoreB - scoreA;
        }
      });

      return lista;
    }

    [fBuscar, fCategoria, fPrecio, fOrden].forEach(function (el) {
      el.addEventListener('input', renderProductos);
      el.addEventListener('change', renderProductos);
    });

    // ---- RENDER OFERTAS DEL D√çA ----
    function renderOfertas() {
      var ofertas = todosProductos.filter(function (p) {
        var base = Number(p.precio || 0);
        var final = calcularPrecioOferta(base, p.oferta_tipo || '', p.oferta_valor || 0);
        return p.oferta_tipo && p.oferta_valor && final > 0 && final < base;
      });

      if (!ofertas.length) {
        ofertasSection.style.display = 'none';
        return;
      }

      ofertasSection.style.display = 'block';
      ofertasSub.textContent =
        ofertas.length + ' producto' + (ofertas.length > 1 ? 's con descuento activo' : ' con descuento activo');

      var maxMostrar = 12;
      var subset = ofertas.slice(0, maxMostrar);

      ofertasList.innerHTML = subset.map(function (p) {
        var base = Number(p.precio || 0);
        var final = calcularPrecioOferta(base, p.oferta_tipo || '', p.oferta_valor || 0);
        var etiqueta = p.oferta_etiqueta || 'OFERTA';

        return (
          '<div class="oferta-item">' +
            '<div class="oferta-img">' +
              (p.imagen_url
                ? '<img src="' + p.imagen_url + '" alt="' + (p.nombre || '') +
                  '" onerror="this.style.opacity=0.3;">'
                : '') +
            '</div>' +
            '<div class="oferta-nombre">' + (p.nombre || '') + '</div>' +
            '<div style="font-size:0.72rem;color:#9ca3af;margin-bottom:0.15rem;">' +
              etiqueta +
            '</div>' +
            '<div class="oferta-precio-row">' +
              '<span class="oferta-precio-main">$ ' + final.toFixed(2) + '</span>' +
              '<span class="oferta-precio-old">$ ' + base.toFixed(2) + '</span>' +
            '</div>' +
            '<button class="oferta-btn" onclick="irAProducto(' + p.id + ')">' +
              '<span>Ver detalle</span> <span>‚Üí</span>' +
            '</button>' +
          '</div>'
        );
      }).join('');
    }

    // ---- GRID PRINCIPAL ----
    function irAProducto(id) {
      var url = 'producto.html?id=' + encodeURIComponent(id);
      if (revId) url += '&rev=' + encodeURIComponent(revId);
      location.href = url;
    }

    function agregarDesdeGrid(idProd) {
      var prod = todosProductos.find(function (p) { return String(p.id) === String(idProd); });
      if (!prod) return;
      var input = document.querySelector('.cat-qty[data-id="' + idProd + '"]');
      var cant = Number(input && input.value ? input.value : 1);
      if (isNaN(cant) || cant <= 0) cant = 1;
      agregarAlCarrito(prod, cant);
    }

    function renderProductos() {
      var lista = aplicarFiltrosOrden();

      if (!lista.length) {
        grid.innerHTML =
          '<div style="grid-column:1/-1; text-align:center; color:#9ca3af;">No hay productos disponibles con estos filtros.</div>';
        return;
      }

      grid.innerHTML = lista.map(function (p) {
        var stock = typeof p.stock === 'number' ? p.stock : 0;
        var stockCls = 'cat-stock';
        var stockText = 'Stock disponible';
        if (stock <= 0) {
          stockCls += ' none';
          stockText = 'Sin stock';
        } else if (stock > 0 && stock <= 3) {
          stockCls += ' low';
          stockText = '¬°√öltimas unidades!';
        }

        var base = Number(p.precio || 0);
        var final = calcularPrecioOferta(base, p.oferta_tipo || '', p.oferta_valor || 0);
        var tieneOferta = p.oferta_tipo && p.oferta_valor && final < base;

        var precioHtml = '';
        if (tieneOferta) {
          precioHtml =
            '<div class="cat-price-row">' +
              '<span class="cat-price-main">$ ' + final.toFixed(2) + '</span>' +
              '<span class="cat-price-old">$ ' + base.toFixed(2) + '</span>' +
            '</div>';
        } else {
          precioHtml = '<div class="cat-price-row"><span class="cat-price-main">$ ' + base.toFixed(2) + '</span></div>';
        }

        var ofertaRibbon = '';
        if (tieneOferta || p.oferta_etiqueta) {
          var txt = p.oferta_etiqueta || 'OFERTA';
          ofertaRibbon =
            '<div class="badge-ribbon"><span>üî•</span><span>' + txt + '</span></div>';
        }

        var metaTags = [];
        if (Array.isArray(p.colores) && p.colores.length) {
          metaTags.push('Colores: ' + p.colores.join(', '));
        }
        if (Array.isArray(p.tamanos) && p.tamanos.length) {
          metaTags.push('Tama√±os: ' + p.tamanos.join(', '));
        }

        return (
          '<div class="cat-card" data-id="' + p.id + '" onclick="irAProducto(' + p.id + ')">' +
            ofertaRibbon +
            '<div class="cat-img-wrap">' +
              (p.imagen_url
                ? '<img src="' + p.imagen_url + '" alt="' + (p.nombre || '') +
                  '" onerror="this.style.opacity=0.3;">'
                : '') +
            '</div>' +
            '<div class="cat-body">' +
              '<div class="cat-name">' + (p.nombre || '') + '</div>' +
              '<div class="cat-cat">' + (p.categoria || 'Sin categor√≠a') + '</div>' +
              precioHtml +
              '<div class="' + stockCls + '">' + stockText + '</div>' +
              (metaTags.length
                ? '<div class="cat-meta">' + metaTags.map(function (t) {
                    return '<span class="tag">' + t + '</span>';
                  }).join('') + '</div>'
                : '') +
              '<div class="cat-actions" onclick="event.stopPropagation()">' +
                '<input type="number" min="1" value="1" class="cat-qty" data-id="' + p.id + '" />' +
                '<button class="btn btn-main" onclick="agregarDesdeGrid(' + p.id + ')">Agregar</button>' +
                '<button class="btn btn-ghost" onclick="irAProducto(' + p.id + ')">Ver m√°s</button>' +
              '</div>' +
            '</div>' +
          '</div>'
        );
      }).join('');
    }

    // ---- CARRITO ----
    function renderCarrito() {
      if (!carrito.length) {
        cartItemsEl.innerHTML = '<div class="cart-empty">Todav√≠a no agregaste productos.</div>';
        cartTotalEl.textContent = '$ 0.00';
        actualizarBadgeCarrito();
        return;
      }
      var total = 0;
      cartItemsEl.innerHTML = carrito.map(function (item, idx) {
        var sub = item.cantidad * item.precio;
        total += sub;
        var detalleVar = '';
        if (item.color) detalleVar += ' ¬∑ ' + item.color;
        if (item.tamano) detalleVar += ' ¬∑ ' + item.tamano;

        return (
          '<div class="cart-item">' +
            '<div>' +
              '<div><strong>' + item.nombre + '</strong></div>' +
              (detalleVar
                ? '<div style="color:#9ca3af; font-size:.7rem;">' + detalleVar + '</div>'
                : '') +
              '<div style="color:#9ca3af; font-size:.75rem;">Cant: ' + item.cantidad + '</div>' +
            '</div>' +
            '<div style="text-align:right;">' +
              '<div>$ ' + sub.toFixed(2) + '</div>' +
              '<button style="border:none;background:none;color:#f97373;font-size:.75rem;cursor:pointer;" ' +
                'data-idx="' + idx + '" data-role="remove">Quitar</button>' +
            '</div>' +
          '</div>'
        );
      }).join('');
      cartTotalEl.textContent = '$ ' + total.toFixed(2);
      actualizarBadgeCarrito();
    }

    function agregarAlCarrito(prod, cantidad) {
      if (cantidad <= 0) return;
      var precioBase = Number(prod.precio || 0);
      var precioFinal = calcularPrecioOferta(
        precioBase,
        prod.oferta_tipo || '',
        prod.oferta_valor || 0
      );
      var precioUsar = precioFinal > 0 ? precioFinal : precioBase;

      var existente = carrito.find(function (i) { return i.id === prod.id; });
      if (existente) {
        existente.cantidad += cantidad;
      } else {
        carrito.push({
          id: prod.id,
          nombre: prod.nombre,
          precio: Number(precioUsar || 0),
          cantidad: cantidad
        });
      }
      guardarCarritoLS();
      renderCarrito();
    }

    function armarMensajeWhatsApp() {
      if (!carrito.length) return 'Hola, quiero hacer un pedido pero todav√≠a no agregu√© productos.';
      var msg = 'Hola! Te paso mi pedido de Punto Bazar:%0A%0A';
      carrito.forEach(function (item) {
        var detalleVar = '';
        if (item.color) detalleVar += ' ¬∑ ' + item.color;
        if (item.tamano) detalleVar += ' ¬∑ ' + item.tamano;

        msg += '‚Ä¢ ' + item.nombre + ' x' + item.cantidad +
          ' - $' + item.precio.toFixed(2) + ' c/u';
        if (detalleVar) msg += ' (' + detalleVar.trim() + ')';
        msg += '%0A';
      });
      var total = carrito.reduce(function (acc, i) {
        return acc + i.cantidad * i.precio;
      }, 0);
      msg += '%0ATotal estimado: $' + total.toFixed(2);

      if (revId) {
        msg += '%0A%0ARevendedor ID: ' + encodeURIComponent(revId);
        if (revNombre) {
          msg += ' (' + encodeURIComponent(revNombre) + ')';
        }
      }

      var nota = (cartNota.value || '').trim();
      if (nota) {
        msg += '%0A%0ANota del cliente:%0A' + encodeURIComponent(nota);
      }

      return msg;
    }

    btnVaciar.addEventListener('click', function () {
      carrito = [];
      guardarCarritoLS();
      renderCarrito();
    });

    btnWspRicardo.addEventListener('click', function () {
      var msg = armarMensajeWhatsApp();
      window.open('https://wa.me/543865740218?text=' + msg, '_blank');
    });
    btnWspEliseo.addEventListener('click', function () {
      var msg = armarMensajeWhatsApp();
      window.open('https://wa.me/543814020542?text=' + msg, '_blank');
    });

    cartItemsEl.addEventListener('click', function (e) {
      var btn = e.target.closest('[data-role="remove"]');
      if (!btn) return;
      var idx = Number(btn.getAttribute('data-idx'));
      if (isNaN(idx)) return;
      carrito.splice(idx, 1);
      guardarCarritoLS();
      renderCarrito();
    });

    // ---- REVVENDEDOR BANNER ----
    function cargarRevendedor() {
      if (!revId) return;
      fetch('/api/revendedores')
        .then(function (r) { return r.json(); })
        .then(function (data) {
          var lista = Array.isArray(data) ? data : [];
          var rev = lista.find(function (r) {
            return String(r.id) === String(revId);
          });
          if (!rev) return;
          revNombre = rev.nombre || '';
          revZona = rev.zona || '';
          revNombreEl.textContent = revNombre || ('Revendedor #' + revId);
          revZonaEl.textContent = revZona ? '¬∑ ' + revZona : '';
          revBanner.style.display = 'flex';
        })
        .catch(function () {});
    }

    // ---- INIT ----
    (function init() {
      fetch('/api/productos/activos')
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
          todosProductos = Array.isArray(data) ? data : [];
          renderCategorias();
          renderOfertas();
          renderProductos();
        })
        .catch(function (e) {
          console.error(e);
          grid.innerHTML =
            '<div style="grid-column:1/-1; text-align:center; color:#f97373;">Error cargando cat√°logo.</div>';
        });
      renderCarrito();
      actualizarBadgeCarrito();
      cargarRevendedor();
    })();
  </script>
</body>
</html>
