<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Punto Bazar - Revendedores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/logo.svg" />
  <style>
    :root {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.98);
      --borde: rgba(148, 163, 184, 0.45);
      --texto: #e5e7eb;
      --muted: #9ca3af;
      --violeta: #8b5cf6;
    }
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: transparent;
      color: var(--texto);
    }
    h1 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
      gap: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: 1rem;
      border: 1px solid var(--borde);
      padding: 1rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #cbd5e1;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.2rem;
      padding: 0.45rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: #020617;
      color: var(--texto);
      font-size: 0.88rem;
    }
    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }
    .chk-wrap {
      margin-top: 0.5rem;
      font-size: 0.82rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      color: #cbd5e1;
    }
    .chk-wrap input {
      width: auto;
      margin-top: 0;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-main {
      background: linear-gradient(135deg, #4f46e5, #a855f7);
      color: #fff;
      box-shadow: 0 12px 30px rgba(88, 80, 236, 0.8);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--texto);
    }
    .btn-mini {
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-danger {
      background: rgba(248, 113, 113, 0.12);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    th, td {
      padding: 0.4rem 0.3rem;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      text-align: left;
    }
    th {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .tabla-wrap {
      max-height: 320px;
      overflow: auto;
      border-radius: 0.8rem;
      border: 1px solid rgba(30, 64, 175, 0.7);
      margin-top: 0.4rem;
    }
    .estado-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .estado-activo {
      background: rgba(22, 163, 74, 0.2);
      color: #bbf7d0;
      border: 1px solid rgba(22, 163, 74, 0.7);
    }
    .estado-inactivo {
      background: rgba(55, 65, 81, 0.7);
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.9);
    }
    .status {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      min-height: 1.1rem;
    }
    .status-ok {
      color: #4ade80;
    }
    .status-error {
      color: #f97373;
    }
    .link-mini {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: bottom;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1>Revendedores</h1>
  <p style="font-size:.86rem;color:#9ca3af;margin-top:-.4rem;margin-bottom:.8rem;">
    Registrá tus revendedores, activalos/desactivalos y generá sus links de catálogo y panel.
  </p>

  <div class="layout">
    <!-- FORM ALTA -->
    <section class="card">
      <h2 style="margin-top:0;font-size:.98rem;">Nuevo revendedor</h2>

      <label for="r-nombre">Nombre</label>
      <input id="r-nombre" placeholder="Ej: Ana Gómez" />

      <div class="row-2">
        <div>
          <label for="r-telefono">Teléfono (WhatsApp)</label>
          <input id="r-telefono" placeholder="Ej: 381..." />
        </div>
        <div>
          <label for="r-zona">Zona</label>
          <input id="r-zona" placeholder="Ej: Centro, Sur, Tucumán" />
        </div>
      </div>

      <div class="chk-wrap">
        <input type="checkbox" id="r-acepta-wsp" checked />
        <label for="r-acepta-wsp" style="margin:0;">Acepta pedidos por WhatsApp</label>
      </div>

      <button id="btn-crear" class="btn btn-main" style="margin-top:.9rem;">
        Crear revendedor
      </button>

      <div id="status" class="status"></div>
    </section>

    <!-- LISTA -->
    <section class="card">
      <h2 style="margin-top:0;font-size:.98rem;">Listado</h2>
      <div class="tabla-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre / zona</th>
              <th>Estado</th>
              <th>Links</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-body">
            <tr>
              <td colspan="5" style="text-align:center;color:#9ca3af;">Cargando revendedores...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p style="font-size:.76rem;color:#9ca3af;margin-top:.5rem;">
        Tip: pasales el link de <strong>catálogo</strong> y el link del <strong>panel del revendedor</strong>
        para que empiecen a vender por vos.
      </p>
    </section>
  </div>

  <script>
    const inpNombre = document.getElementById('r-nombre');
    const inpTelefono = document.getElementById('r-telefono');
    const inpZona = document.getElementById('r-zona');
    const chkAcepta = document.getElementById('r-acepta-wsp');
    const btnCrear = document.getElementById('btn-crear');
    const statusEl = document.getElementById('status');
    const tablaBody = document.getElementById('tabla-body');

    let revendedores = [];

    function setStatus(msg, ok) {
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (msg ? (ok ? ' status-ok' : ' status-error') : '');
    }

    function formatearLinkCorto(url) {
      if (!url) return '';
      if (url.length <= 28) return url;
      return url.slice(0, 25) + '...';
    }

    function cargarRevendedores() {
      tablaBody.innerHTML =
        '<tr><td colspan="5" style="text-align:center;color:#9ca3af;">Cargando revendedores...</td></tr>';

      fetch('/api/revendedores')
        .then(r => r.json())
        .then(data => {
          revendedores = Array.isArray(data) ? data : [];
          renderTabla();
        })
        .catch(() => {
          tablaBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center;color:#f97373;">Error cargando revendedores.</td></tr>';
        });
    }

    function renderTabla() {
      if (!revendedores.length) {
        tablaBody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;color:#9ca3af;">Todavía no registraste revendedores.</td></tr>';
        return;
      }

      const base = window.location.origin;

      const filas = revendedores.map(r => {
        const estado = (r.activo !== false);
        const estadoHtml = estado
          ? '<span class="estado-pill estado-activo">Activo</span>'
          : '<span class="estado-pill estado-inactivo">Inactivo</span>';

        const linkCatalogo = base + '/catalogo.html?rev=' + encodeURIComponent(r.id);
        const linkPanel = base + '/revendedor.html?id=' + encodeURIComponent(r.id);

        return `
          <tr>
            <td>${r.id}</td>
            <td>
              <div><strong>${r.nombre || 'Sin nombre'}</strong></div>
              <div style="color:#9ca3af;">${r.zona || ''}</div>
            </td>
            <td>${estadoHtml}</td>
            <td>
              <div style="margin-bottom:0.2rem;">
                <span style="font-size:.72rem;color:#9ca3af;">Catálogo</span><br/>
                <span class="link-mini">${formatearLinkCorto(linkCatalogo)}</span>
              </div>
              <div>
                <span style="font-size:.72rem;color:#9ca3af;">Panel</span><br/>
                <span class="link-mini">${formatearLinkCorto(linkPanel)}</span>
              </div>
            </td>
            <td>
              <button class="btn-mini" data-role="copiar-cat" data-id="${r.id}">
                Copiar catálogo
              </button><br/>
              <button class="btn-mini" data-role="panel" data-id="${r.id}" style="margin-top:.25rem;">
                Abrir panel
              </button><br/>
              <button class="btn-mini" data-role="toggle" data-id="${r.id}" style="margin-top:.25rem;">
                ${estado ? 'Desactivar' : 'Activar'}
              </button>
            </td>
          </tr>
        `;
      }).join('');

      tablaBody.innerHTML = filas;
    }

    btnCrear.addEventListener('click', () => {
      const nombre = inpNombre.value.trim();
      const telefono = inpTelefono.value.trim();
      const zona = inpZona.value.trim();
      const acepta = !!chkAcepta.checked;

      if (!nombre) {
        setStatus('El nombre es obligatorio.', false);
        return;
      }

      setStatus('Creando revendedor...', true);

      fetch('/api/revendedores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre,
          telefono,
          zona,
          acepta_whatsapp: acepta
        })
      })
        .then(r => r.json())
        .then(() => {
          setStatus('Revendedor creado correctamente.', true);
          inpNombre.value = '';
          inpTelefono.value = '';
          inpZona.value = '';
          chkAcepta.checked = true;
          cargarRevendedores();
        })
        .catch(() => {
          setStatus('Error al crear revendedor.', false);
        });
    });

    tablaBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-role]');
      if (!btn) return;
      const id = Number(btn.getAttribute('data-id'));
      const role = btn.getAttribute('data-role');
      if (!id) return;

      const base = window.location.origin;
      const linkCatalogo = base + '/catalogo.html?rev=' + encodeURIComponent(id);
      const linkPanel = base + '/revendedor.html?id=' + encodeURIComponent(id);

      if (role === 'copiar-cat') {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(linkCatalogo)
            .then(() => setStatus('Link de catálogo copiado.', true))
            .catch(() => setStatus('No se pudo copiar automáticamente.', false));
        } else {
          setStatus('Copiá este link: ' + linkCatalogo, false);
        }
        return;
      }

      if (role === 'panel') {
        window.open(linkPanel, '_blank');
        return;
      }

      if (role === 'toggle') {
        // cambiar activo
        const rev = revendedores.find(r => Number(r.id) === id);
        const nuevoEstado = !(rev && rev.activo !== false);

        fetch('/api/revendedores/' + id + '/activo', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ activo: nuevoEstado })
        })
          .then(r => r.json())
          .then(() => {
            setStatus('Estado actualizado.', true);
            cargarRevendedores();
          })
          .catch(() => {
            setStatus('Error al cambiar estado.', false);
          });
      }
    });

    (function init() {
      cargarRevendedores();
    })();
  </script>
</body>
</html>
