<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Punto Bazar - Panel del revendedor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="/logo.svg" />
  <style>
    :root {
      --bg: #020617;
      --card: rgba(15, 23, 42, 0.98);
      --borde: rgba(148, 163, 184, 0.45);
      --texto: #e5e7eb;
      --muted: #9ca3af;
      --violeta: #8b5cf6;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 75%);
      color: var(--texto);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .wrap {
      max-width: 900px;
      width: 100%;
    }
    .logo {
      text-align: center;
      margin-bottom: 0.6rem;
    }
    .logo img {
      width: 140px;
      filter: drop-shadow(0 14px 36px rgba(15, 23, 42, 0.95));
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 1rem;
    }
    .card {
      background: var(--card);
      border-radius: 1.1rem;
      border: 1px solid var(--borde);
      padding: 1rem;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.95);
    }
    h1 {
      margin: 0 0 .4rem;
      font-size: 1.2rem;
    }
    p {
      margin: 0;
    }
    .rev-nombre {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .rev-zona {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }
    .rev-extra {
      font-size: 0.85rem;
      margin-top: 0.35rem;
      color: #cbd5e1;
    }
    .badge-activo {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
      background: rgba(6, 95, 70, 0.4);
      font-size: 0.75rem;
      margin-top: 0.35rem;
    }
    .badge-inactivo {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--texto);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.75rem;
      margin-top: 0.35rem;
    }
    .fila {
      margin-top: 0.7rem;
      font-size: 0.85rem;
    }
    .fila-label {
      color: var(--muted);
      font-size: 0.8rem;
    }
    .link-box {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
      align-items: center;
    }
    .link-input {
      flex: 1;
      min-width: 200px;
      padding: 0.4rem 0.55rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
      color: var(--texto);
      font-size: 0.82rem;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.75rem;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
    }
    .btn-main {
      background: linear-gradient(135deg, #4f46e5, #a855f7);
      color: #fff;
      box-shadow: 0 12px 30px rgba(88, 80, 236, 0.8);
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--texto);
    }
    .qr-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .qr-wrap img {
      border-radius: 0.75rem;
      border: 1px solid rgba(30, 64, 175, 0.7);
      background: #020617;
      padding: 0.35rem;
    }
    .tips {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.6rem;
    }
    .tips ul {
      padding-left: 1.1rem;
      margin: 0.2rem 0 0;
    }
    .tips li {
      margin-bottom: 0.2rem;
    }
    .status {
      text-align: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.5rem;
      min-height: 1rem;
    }
    .status-ok {
      color: #4ade80;
    }
    .status-error {
      color: #f97373;
    }
    @media (max-width: 900px) {
      body {
        align-items: flex-start;
      }
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <img src="/logo.svg" alt="Punto Bazar" />
    </div>

    <div class="grid">
      <!-- INFO REVENDEDOR -->
      <div class="card">
        <h1>Panel del revendedor</h1>
        <p style="font-size:.85rem;color:#9ca3af;margin-bottom:.6rem;">
          Este panel es solo para uso del revendedor. Compart√≠ tu cat√°logo con tus clientes y sum√° ventas.
        </p>

        <div id="rev-info">
          Cargando datos del revendedor...
        </div>

        <div id="rev-status" class="status"></div>
      </div>

      <!-- LINK + QR + TIPS -->
      <div class="card">
        <h2 style="margin-top:0;font-size:1rem;">Tu link de cat√°logo</h2>
        <p style="font-size:.82rem;color:#9ca3af;margin:0 0 .4rem;">
          Este es el link que ten√©s que compartir con tus clientes. Todo lo que compren por ac√° se registra como
          <strong>tus ventas</strong>.
        </p>

        <div class="fila">
          <div class="fila-label">Link personal</div>
          <div class="link-box">
            <input id="link-catalogo" class="link-input" readonly value="Cargando..." />
            <button id="btn-copiar" class="btn btn-main">Copiar link</button>
            <button id="btn-abrir" class="btn btn-ghost">Abrir cat√°logo</button>
          </div>
        </div>

        <div class="fila">
          <div class="fila-label">C√≥digo QR</div>
          <div class="qr-wrap">
            <img id="qr-img" src="" alt="QR cat√°logo" style="display:none;" />
            <div style="font-size:.78rem;color:#9ca3af;">
              Sac√° captura o guard√° esta imagen para usarla en estados, historias o imprimirla.
            </div>
          </div>
        </div>

        <div class="tips">
          <div style="font-weight:600;margin-bottom:0.15rem;">Tips para vender m√°s üí∏</div>
          <ul>
            <li>Envi√° tu link a tus mejores contactos con un mensaje personalizado.</li>
            <li>Sub√≠ el QR a tus estados de WhatsApp con un texto tipo: ‚ÄúCat√°logo actualizado, hac√© tu pedido ac√°‚Äù.</li>
            <li>Reenvi√° las ofertas que te pasa Punto Bazar al menos 2 veces por semana.</li>
            <li>Respond√© r√°pido los mensajes: los clientes que dudan suelen comprar si los atend√©s al toque.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const revInfoEl = document.getElementById('rev-info');
    const revStatusEl = document.getElementById('rev-status');
    const linkCatalogoEl = document.getElementById('link-catalogo');
    const btnCopiar = document.getElementById('btn-copiar');
    const btnAbrir = document.getElementById('btn-abrir');
    const qrImg = document.getElementById('qr-img');

    let revendedorActual = null;
    let linkCatalogo = '';

    function getRevIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      return id ? Number(id) : null;
    }

    function renderRevendedor(id) {
      if (!revendedorActual) {
        // Modo gen√©rico: igual mostramos algo aprovechable
        revInfoEl.innerHTML = `
          <div class="rev-nombre">Revendedor #${id}</div>
          <div class="rev-zona">A√∫n no est√°s registrado en el sistema de Punto Bazar.</div>
          <div class="rev-extra">
            <div>Pedile a Ricardo o Eliseo que te carguen en la secci√≥n <strong>Revendedores</strong> del panel admin.</div>
          </div>
          <span class="badge-inactivo">Estado: sin registrar</span>
        `;
        revStatusEl.textContent = '';
        revStatusEl.className = 'status';
        return;
      }

      const r = revendedorActual;
      const aceptaWsp = r.acepta_whatsapp ? 'Acepta pedidos por WhatsApp' : 'No usa WhatsApp para pedidos';
      const telefono = r.telefono ? r.telefono : '(sin tel√©fono cargado)';

      const estadoHtml = r.activo !== false
        ? '<span class="badge-activo">Activo ¬∑ puede recibir pedidos</span>'
        : '<span class="badge-inactivo">Inactivo ¬∑ revisar con Punto Bazar</span>';

      revInfoEl.innerHTML = `
        <div class="rev-nombre">${r.nombre || 'Revendedor sin nombre'}</div>
        <div class="rev-zona">${r.zona ? 'Zona: ' + r.zona : 'Zona no especificada'}</div>
        ${estadoHtml}
        <div class="rev-extra">
          <div><strong>Tel√©fono:</strong> ${telefono}</div>
          <div><strong>WhatsApp:</strong> ${aceptaWsp}</div>
        </div>
      `;
      revStatusEl.textContent = '';
      revStatusEl.className = 'status';
    }

    function setCatalogLink(id) {
      linkCatalogo = window.location.origin + '/catalogo.html?rev=' + encodeURIComponent(id);
      linkCatalogoEl.value = linkCatalogo;

      const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' +
        encodeURIComponent(linkCatalogo);
      qrImg.src = qrUrl;
      qrImg.style.display = 'block';
    }

    btnCopiar.addEventListener('click', function () {
      if (!linkCatalogo) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(linkCatalogo)
          .then(() => {
            revStatusEl.textContent = 'Link copiado. Pegalo en tus chats o estados.';
            revStatusEl.className = 'status status-ok';
          })
          .catch(() => {
            revStatusEl.textContent = 'No se pudo copiar autom√°ticamente. Copialo a mano.';
            revStatusEl.className = 'status status-error';
          });
      } else {
        linkCatalogoEl.select();
        revStatusEl.textContent = 'Seleccion√© el texto, ahora copi√° con Ctrl+C.';
        revStatusEl.className = 'status status-ok';
      }
    });

    btnAbrir.addEventListener('click', function () {
      if (!linkCatalogo) return;
      window.open(linkCatalogo, '_blank');
    });

    (function init() {
      const id = getRevIdFromURL();
      if (!id) {
        revInfoEl.innerHTML = `
          <div class="rev-nombre">Panel del revendedor</div>
          <div class="rev-zona">Este link est√° incompleto.</div>
          <div class="rev-extra">
            <div>Pedile a Punto Bazar que te env√≠e tu panel con el formato:</div>
            <div><code>.../revendedor.html?id=TU_NUMERO</code></div>
          </div>
        `;
        revStatusEl.textContent = '';
        return;
      }

      setCatalogLink(id);

      // Intentamos cargar datos desde el backend (si est√° registrado)
      fetch('/api/revendedores')
        .then(r => r.json())
        .then(data => {
          const lista = Array.isArray(data) ? data : [];
          revendedorActual = lista.find(r => Number(r.id) === Number(id)) || null;
          renderRevendedor(id);
        })
        .catch(() => {
          revendedorActual = null;
          renderRevendedor(id);
        });
    })();
  </script>
</body>
</html>
